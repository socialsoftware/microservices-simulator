package {{packageName}};

{{#each imports}}
{{this}}
{{/each}}

@Service
public class {{serviceName}} {
    @Autowired
    private AggregateIdGeneratorService aggregateIdGeneratorService;

    private final UnitOfWorkService<UnitOfWork> unitOfWorkService;

    private final {{entityName}}Repository {{lowerEntityName}}Repository;

    @Autowired
    private {{entityName}}Factory {{lowerEntityName}}Factory;

    public {{serviceName}}(UnitOfWorkService unitOfWorkService, {{entityName}}Repository {{lowerEntityName}}Repository) {
        this.unitOfWorkService = unitOfWorkService;
        this.{{lowerEntityName}}Repository = {{lowerEntityName}}Repository;
    }

{{#each methods}}
    @Retryable(
            value = { SQLException.class, CannotAcquireLockException.class },
            maxAttemptsExpression = "${retry.db.maxAttempts}",
            backoff = @Backoff(
                delayExpression = "${retry.db.delay}",
                multiplierExpression = "${retry.db.multiplier}"
            ))
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public {{returnType}} {{name}}({{#each parameters}}{{type}} {{name}}{{#unless @last}}, {{/unless}}{{/each}}) {
{{#if (eq crudAction "create")}}
        Integer aggregateId = aggregateIdGeneratorService.getNewAggregateId();
        {{entityName}} {{lowerEntityName}} = {{lowerEntityName}}Factory.create{{entityName}}(aggregateId{{#if entityRelationships.single}}{{#each entityRelationships.single}}, {{paramName}}{{/each}}{{/if}}, {{lowerEntityName}}Dto{{#if entityRelationships.collections}}{{#each entityRelationships.collections}}, {{paramName}}{{/each}}{{/if}});
        unitOfWorkService.registerChanged({{lowerEntityName}}, unitOfWork);
        return {{lowerEntityName}}Factory.create{{entityName}}Dto({{lowerEntityName}});
{{else if (eq crudAction "findById")}}
        return {{lowerEntityName}}Factory.create{{entityName}}Dto(({{entityName}}) unitOfWorkService.aggregateLoadAndRegisterRead(aggregateId, unitOfWork));
{{else if (eq crudAction "update")}}
        Integer aggregateId = {{lowerEntityName}}Dto.getAggregateId();
        {{entityName}} old{{entityName}} = ({{entityName}}) unitOfWorkService.aggregateLoadAndRegisterRead(aggregateId, unitOfWork);
        {{entityName}} new{{entityName}} = {{lowerEntityName}}Factory.create{{entityName}}FromExisting(old{{entityName}});
{{#each properties}}
        new{{../entityName}}.set{{capitalizedName}}({{../lowerEntityName}}Dto.get{{capitalizedName}}());
{{/each}}
        unitOfWorkService.registerChanged(new{{entityName}}, unitOfWork);
        unitOfWorkService.registerEvent(new {{../aggregateName}}UpdatedEvent(new{{entityName}}.getAggregateId(){{#each nonFinalProperties}}, new{{../../entityName}}.get{{capitalizedName}}(){{/each}}), unitOfWork);
        return {{lowerEntityName}}Factory.create{{entityName}}Dto(new{{entityName}});
{{else if (eq crudAction "delete")}}
        {{entityName}} old{{entityName}} = ({{entityName}}) unitOfWorkService.aggregateLoadAndRegisterRead(aggregateId, unitOfWork);
        {{entityName}} new{{entityName}} = {{lowerEntityName}}Factory.create{{entityName}}FromExisting(old{{entityName}});
        new{{entityName}}.remove();
        unitOfWorkService.registerChanged(new{{entityName}}, unitOfWork);
        unitOfWorkService.registerEvent(new {{../aggregateName}}DeletedEvent(new{{entityName}}.getAggregateId()), unitOfWork);
{{else if (eq crudAction "findAll")}}
        Set<Integer> aggregateIds = {{lowerEntityName}}Repository.findAll().stream()
                .map({{entityName}}::getAggregateId)
                .collect(Collectors.toSet());
        return aggregateIds.stream()
                .map(id -> ({{entityName}}) unitOfWorkService.aggregateLoadAndRegisterRead(id, unitOfWork))
                .map({{lowerEntityName}}Factory::create{{entityName}}Dto)
                .collect(Collectors.toList());
{{else if (eq crudAction "search")}}
        Set<Integer> aggregateIds = {{lowerEntityName}}Repository.findAll().stream()
                .filter(entity -> {
{{#each searchableProperties}}
                    if ({{name}} != null) {
                        {{#if (eq type "String")}}
                        if (!{{accessor}}.equals({{name}})) {
                            return false;
                        }
                        {{else if (eq type "Boolean")}}
                        if ({{accessor}} != {{name}}) {
                            return false;
                        }
                        {{else}}
                        if (!{{accessor}}.equals({{name}})) {
                            return false;
                        }
                        {{/if}}
                    }
{{/each}}
                    return true;
                })
                .map({{entityName}}::getAggregateId)
                .collect(Collectors.toSet());
        return aggregateIds.stream()
                .map(id -> ({{entityName}}) unitOfWorkService.aggregateLoadAndRegisterRead(id, unitOfWork))
                .map({{lowerEntityName}}Factory::create{{entityName}}Dto)
                .collect(Collectors.toList());
{{else}}
        // TODO: Implement {{name}} method
{{#if (ne returnType "void")}}
        return null;
{{/if}}
{{/if}}
    }

{{/each}}
}
